<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Fancy New Places ‚Äî Staging</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #fafafa; color: #262626; min-height: 100vh; }

        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 1.5rem; text-align: center; position: relative; }
        .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.3rem; }
        .header p { font-size: 0.9rem; opacity: 0.85; }
        .header .build { font-size: 0.65rem; opacity: 0.5; margin-top: 0.3rem; }
        .admin-lock { position: absolute; top: 1rem; right: 1rem; background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem; border-radius: 50%; cursor: pointer; font-size: 1.2rem; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .admin-lock:hover { background: rgba(255,255,255,0.3); }
        .admin-lock.auth { background: #4caf50; }

        .filter-bar { background: white; border-bottom: 1px solid #dbdbdb; position: sticky; top: 0; z-index: 10; }
        .filter-row { display: flex; gap: 0.4rem; padding: 0.6rem 1rem; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .filter-row + .filter-row { padding-top: 0.3rem; border-top: 1px solid #f0f0f0; }
        .filter-btn { padding: 0.4rem 0.8rem; border: 1px solid #dbdbdb; border-radius: 20px; background: white; font-size: 0.8rem; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .filter-btn:hover, .filter-btn.active { background: #262626; color: white; border-color: #262626; }
        .filter-btn.city.active { background: #667eea; border-color: #667eea; }
        .filter-btn.status-new.active { background: #2196f3; border-color: #2196f3; }
        .filter-btn.status-approved.active { background: #4caf50; border-color: #4caf50; }
        .filter-btn.status-rejected.active { background: #e91e63; border-color: #e91e63; }

        .stats { padding: 0.6rem 1.5rem; font-size: 0.8rem; color: #8e8e8e; }

        .places { padding: 0 1rem 2rem; display: grid; gap: 0.8rem; max-width: 600px; margin: 0 auto; }

        .place-card { background: white; border-radius: 12px; border: 1px solid #dbdbdb; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
        .place-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .place-card.approved { border-left: 4px solid #4caf50; }
        .place-card.rejected { border-left: 4px solid #e91e63; opacity: 0.6; }
        .place-card.new { border-left: 4px solid #2196f3; }

        .place-header { display: flex; align-items: center; padding: 0.8rem 1rem; gap: 0.8rem; }
        .place-avatar { width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(45deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.1rem; flex-shrink: 0; }
        .place-info { flex: 1; min-width: 0; }
        .place-name { font-weight: 600; font-size: 0.95rem; }
        .place-handle { color: #8e8e8e; font-size: 0.8rem; }

        .place-body { padding: 0 1rem; }
        .place-bio { font-size: 0.85rem; line-height: 1.4; color: #262626; margin-bottom: 0.6rem; white-space: pre-line; display: -webkit-box; -webkit-line-clamp: 4; -webkit-box-orient: vertical; overflow: hidden; }

        .place-tags { display: flex; gap: 0.3rem; padding: 0 1rem 0.6rem; flex-wrap: wrap; }
        .tag { padding: 0.15rem 0.5rem; border-radius: 10px; font-size: 0.7rem; }
        .tag.city { background: #e3f2fd; color: #1565c0; }
        .tag.cat { background: #e8f5e9; color: #2e7d32; }
        .tag.followers { background: #f3e5f5; color: #7b1fa2; }
        .tag.status-badge { font-weight: 600; }
        .tag.status-new { background: #e3f2fd; color: #1565c0; }
        .tag.status-approved { background: #e8f5e9; color: #2e7d32; }
        .tag.status-rejected { background: #fce4ec; color: #c62828; }

        /* Admin tag editor */
        .admin-tags { padding: 0 1rem 0.6rem; }
        .admin-chips { display: flex; flex-wrap: wrap; gap: 0.3rem; margin-bottom: 0.4rem; }
        .admin-chip { padding: 0.2rem 0.5rem; background: #e8f5e9; color: #2e7d32; border-radius: 12px; font-size: 0.7rem; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .admin-chip:hover { background: #ffcdd2; color: #c62828; }
        .admin-add { padding: 0.2rem 0.5rem; background: #f5f5f5; color: #666; border: 1px dashed #ccc; border-radius: 12px; font-size: 0.7rem; cursor: pointer; }
        .admin-add:hover { background: #e8f5e9; border-color: #4caf50; }
        .admin-input { padding: 0.2rem 0.5rem; border: 1px solid #4caf50; border-radius: 12px; font-size: 0.7rem; outline: none; width: 120px; }

        .place-actions { padding: 0.5rem 1rem 0.8rem; display: flex; align-items: center; justify-content: space-between; }
        .insta-btn { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.4rem 0.8rem; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: white; text-decoration: none; border-radius: 8px; font-size: 0.8rem; font-weight: 500; }
        .admin-btns { display: flex; gap: 0.4rem; }
        .admin-btn { padding: 0.3rem 0.6rem; border: 1px solid #dbdbdb; border-radius: 8px; background: white; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .admin-btn:hover { background: #f0f0f0; }
        .admin-btn.done-yes { background: #e8f5e9; border-color: #4caf50; }
        .admin-btn.done-no { background: #fce4ec; border-color: #e91e63; }

        .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: #262626; color: white; padding: 0.6rem 1.2rem; border-radius: 10px; font-size: 0.85rem; z-index: 100; animation: fadeout 2s forwards; animation-delay: 1s; }
        @keyframes fadeout { to { opacity: 0; } }

        .footer { text-align: center; padding: 2rem; color: #8e8e8e; font-size: 0.75rem; }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.4rem; }
            .header { padding: 1.5rem 1rem; }
            .admin-lock { top: 0.5rem; right: 0.5rem; width: 36px; height: 36px; font-size: 1rem; }
            .places { padding: 0 0.5rem 2rem; }
            .filter-btn { font-size: 0.75rem; padding: 0.35rem 0.65rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ú® Fancy New Places</h1>
        <p>Staging ‚Äî Kuratierung & Verwaltung</p>
        <p class="build">Build: 2026-02-14 16:38</p>
        <button class="admin-lock" id="lockBtn" onclick="toggleAdmin()">üîí</button>
    </div>

    <div class="filter-bar">
        <div class="filter-row" id="status-filters"></div>
        <div class="filter-row" id="city-filters"></div>
        <div class="filter-row" id="cat-filters"></div>
    </div>

    <div class="stats" id="stats"></div>
    <div class="places" id="places"></div>

    <div class="footer">
        Fancy New Places Staging<br>
        <span id="footer-stats"></span>
    </div>

    <script>
    // --- Config ---
    const SUPABASE_URL = 'https://qhsspdblxbmfhjohmmgz.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_1vYTo5zGfGAxfSoVBb4MFA_npt_GxnE';
    const ADMIN_PW = 'fancyadmin2026';
    const AVAILABLE_TAGS = ['cafe','brunch','breakfast','bar','cocktails','wine','patisserie','bakery','juice','bistro','restaurant','lunch','dinner','coffee','matcha','specialty coffee','healthy','vegan'];
    const CAT_EMOJIS = { 'Caf√©':'‚òï','Brunch':'ü•ê','Bar':'üç∏','Patisserie':'üßÅ','Juice Bar':'ü•§' };
    const FILTER_TAGS = {
        'Caf√©': ['cafe','caf√©','coffee','specialty coffee'],
        'Brunch': ['brunch','breakfast'],
        'Bar': ['bar','cocktails','wine'],
        'Patisserie': ['patisserie','bakery'],
        'Juice Bar': ['juice','smoothies'],
    };

    // --- State ---
    let places = [];
    let isAdmin = sessionStorage.getItem('fancyAdmin') === '1';
    let activeStatus = 'all';
    let activeCity = 'all';
    let activeCat = 'all';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- Admin ---
    function toggleAdmin() {
        if (isAdmin) {
            sessionStorage.removeItem('fancyAdmin');
            isAdmin = false;
        } else {
            const pw = prompt('Admin-Passwort:');
            if (pw === ADMIN_PW) { sessionStorage.setItem('fancyAdmin', '1'); isAdmin = true; toast('‚úÖ Admin aktiv'); }
            else if (pw !== null) { alert('Falsches Passwort'); return; }
            else return;
        }
        document.getElementById('lockBtn').textContent = isAdmin ? 'üîì' : 'üîí';
        document.getElementById('lockBtn').classList.toggle('auth', isAdmin);
        render();
    }
    // Init admin UI
    if (isAdmin) { document.getElementById('lockBtn').textContent = 'üîì'; document.getElementById('lockBtn').classList.add('auth'); }

    // --- Helpers ---
    function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function fmtFollowers(n) { return n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'K' : n.toString(); }
    function toast(msg) { const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => t.remove(), 3000); }

    // --- Filters ---
    function getFiltered() {
        return places.filter(p => {
            const status = p.status || 'new';
            if (activeStatus !== 'all' && status !== activeStatus) return false;
            if (activeCity !== 'all' && p.city !== activeCity) return false;
            if (activeCat !== 'all') {
                const tags = (p.tags || []).map(t => t.toLowerCase());
                const match = FILTER_TAGS[activeCat] || [];
                if (!match.some(t => tags.includes(t))) return false;
            }
            return true;
        });
    }

    function setStatus(s, el) { activeStatus = s; document.querySelectorAll('#status-filters .filter-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); render(); }
    function setCity(c, el) { activeCity = c; document.querySelectorAll('#city-filters .filter-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); render(); }
    function setCat(c, el) { activeCat = c; document.querySelectorAll('#cat-filters .filter-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); render(); }

    // --- Render ---
    function render() {
        const filtered = getFiltered();
        const allStatuses = { new: 0, approved: 0, rejected: 0 };
        places.forEach(p => { const s = p.status || 'new'; allStatuses[s] = (allStatuses[s] || 0) + 1; });

        document.getElementById('stats').innerHTML = `${filtered.length} Places` +
            (activeStatus === 'all' ? ` ‚Äî <strong>${allStatuses.new}</strong> New ¬∑ <strong>${allStatuses.approved}</strong> Approved ¬∑ <strong>${allStatuses.rejected}</strong> Rejected` : '');

        const container = document.getElementById('places');
        if (!filtered.length) { container.innerHTML = '<p style="padding:2rem;text-align:center;color:#8e8e8e">Keine Places in dieser Ansicht.</p>'; return; }

        container.innerHTML = filtered.map(p => {
            const status = p.status || 'new';
            const tags = p.tags || [];

            // Admin: tag editor
            const tagEditor = isAdmin ? `
                <div class="admin-tags">
                    <div class="admin-chips">
                        ${tags.map(t => `<span class="admin-chip" onclick="removeTag('${p.handle}','${t}')" title="Entfernen">${esc(t)}</span>`).join('')}
                        <span class="admin-add" id="add-${p.handle}" onclick="showInput('${p.handle}')">+</span>
                    </div>
                </div>` : '';

            // Admin: approve/reject buttons
            const adminBtns = isAdmin ? `
                <div class="admin-btns">
                    <button class="admin-btn ${status === 'approved' ? 'done-yes' : ''}" onclick="setPlaceStatus('${p.handle}','approved')" title="Approve">‚úÖ</button>
                    <button class="admin-btn ${status === 'rejected' ? 'done-no' : ''}" onclick="setPlaceStatus('${p.handle}','rejected')" title="Reject">‚ùå</button>
                </div>` : '';

            return `
            <div class="place-card ${status}">
                <div class="place-header">
                    <div class="place-avatar">${(p.name||p.handle)[0].toUpperCase()}</div>
                    <div class="place-info">
                        <div class="place-name">${esc(p.name || p.handle)}</div>
                        <div class="place-handle">@${p.handle}</div>
                    </div>
                </div>
                ${p.bio ? `<div class="place-body"><div class="place-bio">${esc(p.bio)}</div></div>` : ''}
                ${tagEditor}
                <div class="place-tags">
                    <span class="tag status-badge status-${status}">${status === 'approved' ? '‚úÖ Approved' : status === 'rejected' ? '‚ùå Rejected' : 'üÜï New'}</span>
                    <span class="tag city">üìç ${p.city}</span>
                    ${!isAdmin ? tags.map(t => `<span class="tag cat">${esc(t)}</span>`).join('') : ''}
                    <span class="tag followers">${fmtFollowers(p.followers || 0)} followers</span>
                </div>
                <div class="place-actions">
                    <a href="https://instagram.com/${p.handle}" target="_blank" class="insta-btn">üì∏ Profil √∂ffnen</a>
                    ${adminBtns}
                </div>
            </div>`;
        }).join('');
    }

    // --- Admin Actions ---
    async function setPlaceStatus(handle, status) {
        if (!isAdmin) return;
        const { error } = await sb.from('places_live').update({ status }).eq('handle', handle);
        if (error) { toast('‚ùå Fehler'); console.error(error); return; }
        const p = places.find(x => x.handle === handle);
        if (p) p.status = status;
        render();
        toast(status === 'approved' ? '‚úÖ Approved' : '‚ùå Rejected');
    }

    async function removeTag(handle, tag) {
        if (!isAdmin) return;
        const p = places.find(x => x.handle === handle);
        if (!p) return;
        const newTags = (p.tags || []).filter(t => t !== tag);
        const { error } = await sb.from('places_live').update({ tags: newTags }).eq('handle', handle);
        if (error) { toast('‚ùå Fehler'); return; }
        p.tags = newTags;
        render();
        toast('Tag entfernt');
    }

    function showInput(handle) {
        const el = document.getElementById('add-' + handle);
        if (!el) return;
        el.outerHTML = `<input class="admin-input" id="input-${handle}" list="dl-${handle}" placeholder="Tag..." onkeydown="if(event.key==='Enter'){addTag('${handle}');event.preventDefault()}" onblur="setTimeout(()=>addTag('${handle}'),200)"><datalist id="dl-${handle}">${AVAILABLE_TAGS.map(t=>'<option value="'+t+'">').join('')}</datalist>`;
        setTimeout(() => document.getElementById('input-' + handle)?.focus(), 10);
    }

    async function addTag(handle) {
        const input = document.getElementById('input-' + handle);
        if (!input) return;
        const tag = input.value.trim().toLowerCase();
        if (!tag) { render(); return; }
        const p = places.find(x => x.handle === handle);
        if (!p) return;
        if ((p.tags || []).includes(tag)) { toast('Existiert bereits'); render(); return; }
        const newTags = [...(p.tags || []), tag];
        const { error } = await sb.from('places_live').update({ tags: newTags }).eq('handle', handle);
        if (error) { toast('‚ùå Fehler'); return; }
        p.tags = newTags;
        render();
        toast('‚úÖ Tag hinzugef√ºgt');
    }

    // --- Build Filters ---
    function buildFilters() {
        // Status filters (always visible)
        const counts = { new: 0, approved: 0, rejected: 0 };
        places.forEach(p => { const s = p.status || 'new'; counts[s] = (counts[s] || 0) + 1; });
        document.getElementById('status-filters').innerHTML =
            `<button class="filter-btn active" onclick="setStatus('all',this)">Alle (${places.length})</button>` +
            `<button class="filter-btn status-new" onclick="setStatus('new',this)">üÜï New (${counts.new})</button>` +
            `<button class="filter-btn status-approved" onclick="setStatus('approved',this)">‚úÖ Approved (${counts.approved})</button>` +
            `<button class="filter-btn status-rejected" onclick="setStatus('rejected',this)">‚ùå Rejected (${counts.rejected})</button>`;

        // City filters
        const cities = [...new Set(places.map(p => p.city))].sort();
        document.getElementById('city-filters').innerHTML =
            `<button class="filter-btn city active" onclick="setCity('all',this)">Alle St√§dte</button>` +
            cities.map(c => `<button class="filter-btn city" onclick="setCity('${c}',this)">${c}</button>`).join('');

        // Category filters
        const cats = ['Caf√©','Brunch','Bar','Patisserie','Juice Bar'];
        document.getElementById('cat-filters').innerHTML =
            `<button class="filter-btn active" onclick="setCat('all',this)">Alle</button>` +
            cats.map(c => `<button class="filter-btn" onclick="setCat('${c}',this)">${CAT_EMOJIS[c]||'üìç'} ${c}</button>`).join('');
    }

    // --- Init ---
    async function init() {
        // Load from Supabase
        const { data, error } = await sb.from('places_live').select('*');
        if (error || !data) {
            console.error('Supabase error:', error);
            document.getElementById('places').innerHTML = '<p style="padding:2rem;text-align:center">‚ùå Daten konnten nicht geladen werden.</p>';
            return;
        }
        places = data.map(p => ({
            ...p,
            status: p.status || 'new',
            tags: p.tags || [],
        }));

        // Sort: new first, then approved, then rejected; within group by city then name
        const order = { new: 0, approved: 1, rejected: 2 };
        places.sort((a, b) => {
            const so = (order[a.status] ?? 0) - (order[b.status] ?? 0);
            if (so !== 0) return so;
            const cc = (a.city || '').localeCompare(b.city || '');
            if (cc !== 0) return cc;
            return (a.name || a.handle).localeCompare(b.name || b.handle);
        });

        buildFilters();
        render();
        document.getElementById('footer-stats').textContent = `${places.length} Places ¬∑ Staging`;
    }

    init();
    </script>
</body>
</html>
