<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fancy New Places ‚Äî Admin</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #262626;
            min-height: 100vh;
        }

        /* Login */
        .login-overlay {
            position: fixed; inset: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000;
        }
        .login-box {
            background: white; border-radius: 16px; padding: 2.5rem;
            width: 90%; max-width: 360px; text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-box h2 { margin-bottom: 0.5rem; font-size: 1.4rem; }
        .login-box p { color: #8e8e8e; font-size: 0.85rem; margin-bottom: 1.5rem; }
        .login-box input {
            width: 100%; padding: 0.8rem 1rem; border: 1px solid #ddd;
            border-radius: 8px; font-size: 1rem; margin-bottom: 1rem;
            outline: none; transition: border-color 0.2s;
        }
        .login-box input:focus { border-color: #667eea; }
        .login-box button {
            width: 100%; padding: 0.8rem; border: none; border-radius: 8px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white; font-size: 1rem; font-weight: 600; cursor: pointer;
        }
        .login-error { color: #e91e63; font-size: 0.85rem; margin-top: 0.5rem; display: none; }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 1.2rem 1.5rem;
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h1 { font-size: 1.3rem; font-weight: 700; }
        .header-right { display: flex; gap: 0.8rem; align-items: center; }
        .logout-btn {
            background: rgba(255,255,255,0.2); border: none; color: white;
            padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;
        }

        /* Tabs */
        .tabs {
            display: flex; background: white; border-bottom: 1px solid #ddd;
            position: sticky; top: 0; z-index: 10;
        }
        .tab {
            flex: 1; padding: 0.8rem; text-align: center; cursor: pointer;
            font-size: 0.9rem; font-weight: 500; border-bottom: 3px solid transparent;
            transition: all 0.2s; color: #888;
        }
        .tab:hover { background: #fafafa; }
        .tab.active { color: #262626; border-bottom-color: #667eea; }
        .tab .count {
            display: inline-block; min-width: 20px; padding: 0.1rem 0.5rem;
            border-radius: 10px; font-size: 0.75rem; margin-left: 0.3rem; font-weight: 600;
        }
        .tab.active .count { background: #667eea; color: white; }
        .tab:not(.active) .count { background: #eee; color: #888; }

        /* Filters */
        .filter-bar {
            background: white; border-bottom: 1px solid #eee;
            padding: 0.6rem 1rem; display: flex; gap: 0.5rem; overflow-x: auto;
        }
        .filter-chip {
            padding: 0.35rem 0.8rem; border: 1px solid #ddd; border-radius: 16px;
            background: white; font-size: 0.8rem; cursor: pointer; white-space: nowrap;
            transition: all 0.15s;
        }
        .filter-chip:hover, .filter-chip.active { background: #262626; color: white; border-color: #262626; }

        /* Cards */
        .cards { padding: 1rem; max-width: 700px; margin: 0 auto; }
        .card {
            background: white; border-radius: 12px; border: 1px solid #e0e0e0;
            margin-bottom: 0.8rem; overflow: hidden; transition: box-shadow 0.2s;
        }
        .card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .card-main { display: flex; padding: 1rem; gap: 0.8rem; }
        .card-avatar {
            width: 52px; height: 52px; border-radius: 50%; flex-shrink: 0;
            background: #eee; object-fit: cover;
        }
        .card-info { flex: 1; min-width: 0; }
        .card-name { font-weight: 600; font-size: 0.95rem; }
        .card-handle { color: #8e8e8e; font-size: 0.8rem; }
        .card-bio {
            font-size: 0.85rem; color: #555; margin-top: 0.4rem;
            white-space: pre-line; line-height: 1.4;
        }
        .card-meta {
            display: flex; gap: 1rem; padding: 0 1rem; font-size: 0.75rem; color: #999;
        }
        .card-meta span { display: flex; align-items: center; gap: 0.2rem; }

        /* Tags */
        .card-tags { padding: 0.6rem 1rem; display: flex; flex-wrap: wrap; gap: 0.3rem; align-items: center; }
        .tag {
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.2rem 0.6rem; background: #f0f0f0; border-radius: 10px;
            font-size: 0.75rem; color: #555;
        }
        .tag .remove-tag {
            cursor: pointer; font-size: 0.7rem; color: #999;
            margin-left: 0.1rem; font-weight: bold;
        }
        .tag .remove-tag:hover { color: #e91e63; }
        .add-tag-btn {
            width: 24px; height: 24px; border-radius: 50%; border: 1px dashed #ccc;
            background: none; cursor: pointer; font-size: 0.9rem; color: #999;
            display: flex; align-items: center; justify-content: center;
        }
        .add-tag-btn:hover { border-color: #667eea; color: #667eea; }

        /* Tag dropdown */
        .tag-dropdown {
            position: relative; display: inline-block;
        }
        .tag-dropdown-menu {
            display: none; position: absolute; bottom: 100%; left: 0;
            background: white; border: 1px solid #ddd; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 0.4rem;
            z-index: 20; max-height: 200px; overflow-y: auto; min-width: 140px;
        }
        .tag-dropdown-menu.open { display: flex; flex-wrap: wrap; gap: 0.3rem; }
        .tag-option {
            padding: 0.3rem 0.6rem; border-radius: 8px; font-size: 0.75rem;
            cursor: pointer; white-space: nowrap; background: #f5f5f5;
        }
        .tag-option:hover { background: #667eea; color: white; }

        /* Actions */
        .card-actions {
            padding: 0.6rem 1rem 1rem; display: flex; justify-content: space-between; align-items: center;
        }
        .insta-link {
            display: inline-flex; align-items: center; gap: 0.3rem;
            color: #c13584; text-decoration: none; font-size: 0.85rem; font-weight: 500;
        }
        .action-btns { display: flex; gap: 0.5rem; }
        .action-btn {
            padding: 0.5rem 1rem; border: 1px solid #ddd; border-radius: 8px;
            background: white; cursor: pointer; font-size: 0.9rem; transition: all 0.15s;
        }
        .action-btn.approve:hover { background: #e8f5e9; border-color: #4caf50; }
        .action-btn.reject:hover { background: #fce4ec; border-color: #e91e63; }
        .action-btn.revert:hover { background: #e3f2fd; border-color: #667eea; }

        .empty-state {
            text-align: center; padding: 3rem; color: #999; font-size: 0.95rem;
        }

        .city-divider {
            font-size: 0.85rem; font-weight: 600; color: #667eea;
            padding: 1rem 0 0.4rem; margin-top: 0.3rem;
            border-bottom: 2px solid #667eea;
        }

        @media (max-width: 480px) {
            .card-main { padding: 0.8rem; }
            .header h1 { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

<!-- Login -->
<div class="login-overlay" id="loginOverlay">
    <div class="login-box">
        <h2>‚ú® Fancy Admin</h2>
        <p>Staging-Dashboard f√ºr Fancy New Places</p>
        <input type="password" id="loginPassword" placeholder="Admin-Passwort" onkeydown="if(event.key==='Enter')doLogin()">
        <button onclick="doLogin()">Einloggen</button>
        <div class="login-error" id="loginError">Falsches Passwort</div>
    </div>
</div>

<!-- App -->
<div id="app" style="display:none">
    <div class="header">
        <h1>‚ú® Fancy Admin</h1>
        <div class="header-right">
            <button class="logout-btn" onclick="doLogout()">Logout</button>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" data-status="new" onclick="switchTab('new')">
            üÜï New <span class="count" id="countNew">0</span>
        </div>
        <div class="tab" data-status="approved" onclick="switchTab('approved')">
            ‚úÖ Approved <span class="count" id="countApproved">0</span>
        </div>
        <div class="tab" data-status="rejected" onclick="switchTab('rejected')">
            ‚ùå Rejected <span class="count" id="countRejected">0</span>
        </div>
    </div>

    <div class="filter-bar" id="filterBar">
        <div class="filter-chip active" onclick="filterCity('all', this)">Alle</div>
    </div>

    <div class="cards" id="cards"></div>
</div>

<script>
const SUPABASE_URL = 'https://qhsspdblxbmfhjohmmgz.supabase.co';
const ANON_KEY = 'sb_publishable_1vYTo5zGfGAxfSoVBb4MFA_npt_GxnE';
// Service key is only used after login ‚Äî base64 encoded
const SK = 'c2Jfc2VjcmV0X1hiVE9xVXVZZ1MxS0ZUSFhObDNKb3dfMElTS0pWdjI=';

const ALL_TAGS = ['cafe','bar','dinner','lunch','brunch','breakfast','juice','cocktails','wine','patisserie','bakery','coffee','matcha','healthy','vegan','bistro','restaurant'];
const TAG_EMOJI = {cafe:'‚òï',bar:'üç∏',dinner:'üçΩÔ∏è',lunch:'ü•ó',brunch:'ü•ê',breakfast:'üç≥',juice:'ü•§',cocktails:'üçπ',wine:'üç∑',patisserie:'üßÅ',bakery:'ü•ñ',coffee:'‚òï',matcha:'üçµ',healthy:'ü•¨',vegan:'üå±',bistro:'ü•ñ',restaurant:'üçΩÔ∏è'};

let sb = null;
let places = [];
let currentTab = 'new';
let currentCity = 'all';

// Auth
const ADMIN_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918'; // sha256 of admin password

async function sha256(msg) {
    const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
}

async function doLogin() {
    const pw = document.getElementById('loginPassword').value;
    // Simple password check
    if (pw === atob('RmFuY3lBZG1pbjIwMjYh')) {
        localStorage.setItem('fancyAdmin', '1');
        showApp();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function doLogout() {
    localStorage.removeItem('fancyAdmin');
    location.reload();
}

function showApp() {
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    initApp();
}

function getServiceKey() {
    return atob(SK);
}

async function initApp() {
    sb = window.supabase.createClient(SUPABASE_URL, getServiceKey());
    await loadPlaces();
}

async function loadPlaces() {
    const { data, error } = await sb.from('places_live').select('*').order('city').order('name');
    if (error) { console.error(error); return; }
    places = data || [];
    updateCounts();
    buildCityFilters();
    renderCards();
}

function updateCounts() {
    const counts = { new: 0, approved: 0, rejected: 0 };
    places.forEach(p => { if (counts[p.status] !== undefined) counts[p.status]++; });
    document.getElementById('countNew').textContent = counts.new;
    document.getElementById('countApproved').textContent = counts.approved;
    document.getElementById('countRejected').textContent = counts.rejected;
}

function buildCityFilters() {
    const cities = [...new Set(places.filter(p => p.status === currentTab).map(p => p.city))].sort();
    const bar = document.getElementById('filterBar');
    bar.innerHTML = `<div class="filter-chip ${currentCity==='all'?'active':''}" onclick="filterCity('all', this)">Alle</div>`;
    cities.forEach(c => {
        bar.innerHTML += `<div class="filter-chip ${currentCity===c?'active':''}" onclick="filterCity('${c}', this)">${c}</div>`;
    });
}

function filterCity(city, el) {
    currentCity = city;
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    if (el) el.classList.add('active');
    renderCards();
}

function switchTab(status) {
    currentTab = status;
    currentCity = 'all';
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.status === status));
    buildCityFilters();
    renderCards();
}

function renderCards() {
    const container = document.getElementById('cards');
    const filtered = places
        .filter(p => p.status === currentTab && (currentCity === 'all' || p.city === currentCity))
        .sort((a, b) => a.city.localeCompare(b.city) || (a.name || a.handle).localeCompare(b.name || b.handle));

    if (filtered.length === 0) {
        container.innerHTML = `<div class="empty-state">${
            currentTab === 'new' ? 'üéâ Keine neuen Places zum Reviewen' :
            currentTab === 'approved' ? 'Noch keine approved Places' :
            'Keine rejected Places'
        }</div>`;
        return;
    }

    let html = '';
    let lastCity = '';

    filtered.forEach(p => {
        if (p.city !== lastCity) {
            lastCity = p.city;
            html += `<div class="city-divider">üìç ${p.city}</div>`;
        }

        const tags = (p.tags || []);
        const availableTags = ALL_TAGS.filter(t => !tags.includes(t));
        const placeTags = tags.map(t =>
            `<span class="tag">${TAG_EMOJI[t]||'üè∑Ô∏è'} ${t} <span class="remove-tag" onclick="removeTag('${p.id}','${t}')">‚úï</span></span>`
        ).join('');

        const avatarSrc = p.profile_pic_url || '';
        const avatarHtml = avatarSrc
            ? `<img class="card-avatar" src="${esc(avatarSrc)}" onerror="this.style.display='none'">`
            : `<div class="card-avatar" style="display:flex;align-items:center;justify-content:center;background:linear-gradient(45deg,#f09433,#dc2743);color:white;font-weight:700;font-size:1.2rem">${(p.name||p.handle)[0]}</div>`;

        let actionBtns = '';
        if (currentTab === 'new') {
            actionBtns = `
                <button class="action-btn approve" onclick="setStatus('${p.id}','approved')">üëç Approve</button>
                <button class="action-btn reject" onclick="setStatus('${p.id}','rejected')">üëé Reject</button>`;
        } else if (currentTab === 'approved') {
            actionBtns = `
                <button class="action-btn reject" onclick="setStatus('${p.id}','rejected')">üëé Reject</button>
                <button class="action-btn revert" onclick="setStatus('${p.id}','new')">‚Ü©Ô∏è New</button>`;
        } else {
            actionBtns = `
                <button class="action-btn approve" onclick="setStatus('${p.id}','approved')">üëç Approve</button>
                <button class="action-btn revert" onclick="setStatus('${p.id}','new')">‚Ü©Ô∏è New</button>`;
        }

        html += `
        <div class="card" id="card-${p.id}">
            <div class="card-main">
                ${avatarHtml}
                <div class="card-info">
                    <div class="card-name">${esc(p.name || p.handle)}</div>
                    <div class="card-handle">@${esc(p.handle)}</div>
                    ${p.bio ? `<div class="card-bio">${esc(p.bio)}</div>` : ''}
                </div>
            </div>
            <div class="card-meta">
                <span>üìç ${esc(p.city)}</span>
                ${p.followers ? `<span>üë• ${fmtNum(p.followers)}</span>` : ''}
                ${p.posts ? `<span>üì∏ ${p.posts}</span>` : ''}
            </div>
            <div class="card-tags" id="tags-${p.id}">
                ${placeTags}
                <div class="tag-dropdown">
                    <button class="add-tag-btn" onclick="toggleDropdown('dd-${p.id}')">+</button>
                    <div class="tag-dropdown-menu" id="dd-${p.id}">
                        ${availableTags.map(t => `<div class="tag-option" onclick="addTag('${p.id}','${t}')">${TAG_EMOJI[t]||''} ${t}</div>`).join('')}
                        ${availableTags.length === 0 ? '<div style="padding:0.3rem;color:#999;font-size:0.75rem">Alle Tags vergeben</div>' : ''}
                    </div>
                </div>
            </div>
            <div class="card-actions">
                <a href="https://instagram.com/${esc(p.handle)}" target="_blank" class="insta-link">üì∏ Instagram</a>
                <div class="action-btns">${actionBtns}</div>
            </div>
        </div>`;
    });

    container.innerHTML = html;
}

function toggleDropdown(id) {
    // Close all others
    document.querySelectorAll('.tag-dropdown-menu.open').forEach(m => { if(m.id!==id) m.classList.remove('open'); });
    document.getElementById(id).classList.toggle('open');
}

// Close dropdowns on outside click
document.addEventListener('click', e => {
    if (!e.target.closest('.tag-dropdown')) {
        document.querySelectorAll('.tag-dropdown-menu.open').forEach(m => m.classList.remove('open'));
    }
});

async function setStatus(id, status) {
    const card = document.getElementById('card-' + id);
    if (card) card.style.opacity = '0.5';

    const { error } = await sb.from('places_live').update({ status }).eq('id', id);
    if (error) { console.error(error); alert('Fehler: ' + error.message); return; }

    // Update local
    const p = places.find(x => x.id === id);
    if (p) p.status = status;
    updateCounts();
    buildCityFilters();
    renderCards();
}

async function addTag(id, tag) {
    const p = places.find(x => x.id === id);
    if (!p) return;
    const newTags = [...(p.tags || []), tag];
    const { error } = await sb.from('places_live').update({ tags: newTags }).eq('id', id);
    if (error) { console.error(error); alert('Fehler: ' + error.message); return; }
    p.tags = newTags;
    renderCards();
}

async function removeTag(id, tag) {
    const p = places.find(x => x.id === id);
    if (!p) return;
    const newTags = (p.tags || []).filter(t => t !== tag);
    const { error } = await sb.from('places_live').update({ tags: newTags }).eq('id', id);
    if (error) { console.error(error); alert('Fehler: ' + error.message); return; }
    p.tags = newTags;
    renderCards();
}

function esc(s) {
    if (!s) return '';
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
}

function fmtNum(n) {
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
    if (n >= 1000) return (n/1000).toFixed(1) + 'K';
    return n;
}

// Init
if (localStorage.getItem('fancyAdmin') === '1') {
    showApp();
} 
</script>
</body>
</html>
