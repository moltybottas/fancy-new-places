<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="v0.5.0">
    <title>Fancy New Places ‚Äî Deutschland</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #262626;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 1.5rem;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 1.8rem; font-weight: 700; margin-bottom: 0.3rem; }
        .header p { font-size: 0.9rem; opacity: 0.85; }

        .admin-lock {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .admin-lock:hover { background: rgba(255,255,255,0.3); }
        .admin-lock.authenticated { background: #4caf50; }

        .filter-bar {
            background: white;
            border-bottom: 1px solid #dbdbdb;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .filter-row {
            display: flex;
            gap: 0.4rem;
            padding: 0.6rem 1rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .filter-row:first-child { padding-bottom: 0.3rem; }
        .filter-row:last-child { padding-top: 0.3rem; border-top: 1px solid #f0f0f0; }
        .filter-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid #dbdbdb;
            border-radius: 20px;
            background: white;
            font-size: 0.8rem;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: #262626;
            color: white;
            border-color: #262626;
        }
        .filter-btn.city-btn.active {
            background: #667eea;
            border-color: #667eea;
        }

        .stats {
            padding: 0.6rem 1.5rem;
            font-size: 0.8rem;
            color: #8e8e8e;
            display: flex;
            justify-content: space-between;
        }

        .places {
            padding: 0 1rem 2rem;
            display: grid;
            gap: 0.8rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .place-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #dbdbdb;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .place-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .place-header {
            display: flex;
            align-items: center;
            padding: 0.8rem 1rem;
            gap: 0.8rem;
        }
        .place-avatar {
            width: 44px; height: 44px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 700; font-size: 1.1rem; flex-shrink: 0;
        }
        .place-avatar.discovery {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        .place-info { flex: 1; min-width: 0; }
        .place-name { font-weight: 600; font-size: 0.95rem; }
        .place-handle { color: #8e8e8e; font-size: 0.8rem; }

        .place-body { padding: 0 1rem; }
        .place-bio {
            font-size: 0.85rem; line-height: 1.4; color: #262626;
            margin-bottom: 0.6rem;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .place-tags {
            display: flex; gap: 0.3rem; padding: 0 1rem 0.6rem; flex-wrap: wrap;
        }
        .tag {
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
        }
        .tag.cat { background: #e8f5e9; color: #2e7d32; }
        .tag.city { background: #e3f2fd; color: #1565c0; }
        .tag.followers { background: #f3e5f5; color: #7b1fa2; }
        .tag.source-pos { background: #e8f5e9; color: #2e7d32; font-weight: 600; }
        .tag.source-disc { background: #e3f2fd; color: #1565c0; font-weight: 600; }
        .tag.proof { background: #fff3e0; color: #e65100; }

        .place-actions {
            padding: 0.5rem 1rem 0.8rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .insta-btn {
            display: inline-flex; align-items: center; gap: 0.3rem;
            padding: 0.4rem 0.8rem;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            color: white; text-decoration: none; border-radius: 8px;
            font-size: 0.8rem; font-weight: 500;
        }
        .vote-btns { display: flex; gap: 0.4rem; }
        .vote-btn {
            padding: 0.3rem 0.6rem;
            border: 1px solid #dbdbdb; border-radius: 8px;
            background: white; cursor: pointer; font-size: 0.9rem;
            transition: all 0.2s;
        }
        .vote-btn:hover { background: #f0f0f0; }
        .vote-btn.voted-yes { background: #e8f5e9; border-color: #4caf50; }
        .vote-btn.voted-no { background: #fce4ec; border-color: #e91e63; }

        .vote-counts {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #8e8e8e;
            padding: 0 1rem 0.5rem;
            margin-top: -0.3rem;
        }

        /* Admin tag editor styles */
        .admin-tags-section {
            padding: 0 1rem 0.6rem;
        }
        .admin-tag-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
            margin-bottom: 0.4rem;
        }
        .admin-tag-chip {
            padding: 0.2rem 0.5rem;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 12px;
            font-size: 0.7rem;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .admin-tag-chip:hover {
            background: #ffcdd2;
            color: #c62828;
        }
        .admin-tag-chip.removing {
            background: #ffcdd2;
            color: #c62828;
            text-decoration: line-through;
        }
        .admin-tag-add {
            padding: 0.2rem 0.5rem;
            background: #f5f5f5;
            color: #666;
            border: 1px dashed #ccc;
            border-radius: 12px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-tag-add:hover {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #4caf50;
        }
        .admin-tag-input {
            padding: 0.2rem 0.5rem;
            border: 1px solid #4caf50;
            border-radius: 12px;
            font-size: 0.7rem;
            outline: none;
            width: 120px;
        }
        .admin-tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
            margin-top: 0.3rem;
        }
        .admin-tag-suggestion {
            padding: 0.15rem 0.4rem;
            background: #fff3e0;
            color: #e65100;
            border-radius: 10px;
            font-size: 0.65rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-tag-suggestion:hover {
            background: #e65100;
            color: white;
        }

        /* Admin approve/reject styles */
        .admin-actions {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }
        .admin-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .admin-btn.approve {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .admin-btn.approve:hover, .admin-btn.approve.active {
            background: #4caf50;
            color: white;
        }
        .admin-btn.reject {
            background: #fce4ec;
            color: #c62828;
        }
        .admin-btn.reject:hover, .admin-btn.reject.active {
            background: #e91e63;
            color: white;
        }
        .place-card.status-approved {
            border-left: 4px solid #4caf50;
        }
        .place-card.status-rejected {
            border-left: 4px solid #e91e63;
            opacity: 0.6;
        }

        .export-bar {
            position: sticky; bottom: 0; z-index: 10;
            background: white; border-top: 1px solid #dbdbdb;
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center; gap: 1rem;
        }
        .export-btn {
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px;
            font-size: 0.9rem; font-weight: 600; cursor: pointer;
        }
        .export-btn:active { opacity: 0.8; }
        .export-count { font-size: 0.8rem; color: #8e8e8e; }
        .export-toast {
            position: fixed; bottom: 5rem; left: 50%; transform: translateX(-50%);
            background: #262626; color: white; padding: 0.6rem 1.2rem;
            border-radius: 10px; font-size: 0.85rem; z-index: 100;
            animation: fadeout 2s forwards; animation-delay: 1s;
        }
        @keyframes fadeout { to { opacity: 0; } }

        .footer {
            text-align: center; padding: 2rem; color: #8e8e8e; font-size: 0.75rem;
        }

        .footer-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .footer-lock {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 0.2rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .footer-lock:hover { opacity: 1; }
        .footer-lock.authenticated { opacity: 1; }

        @media (max-width: 480px) {
            .header h1 { font-size: 1.4rem; }
            .header { padding: 1.5rem 1rem; }
            .admin-lock {
                top: 0.5rem;
                right: 0.5rem;
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            .places { padding: 0 0.5rem 2rem; }
            .filter-btn { font-size: 0.75rem; padding: 0.35rem 0.65rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>‚ú® Fancy New Places</h1>
        <p>Die angesagtesten neuen Spots in Deutschland</p>
        <p style="font-size:0.65rem;opacity:0.5;margin-top:0.3rem">Build: 2026-02-14 15:52</p>
        <button class="admin-lock" id="adminLock" onclick="toggleAdminAuth()" title="Admin Login">üîí</button>
    </div>

    <div class="filter-bar">
        <div class="filter-row" id="city-filters"></div>
        <div class="filter-row" id="cat-filters"></div>
    </div>

    <div class="stats" id="stats"></div>
    <div class="places" id="places"></div>

    <div class="export-bar" id="export-bar" style="display:none;">
        <button class="export-btn" onclick="exportVotes()">üìã Votes exportieren</button>
        <span class="export-count" id="export-count"></span>
    </div>

    <div class="footer">
        <div class="footer-content">
            <span>Fancy New Places ‚Äî v0.5</span>
            <button class="footer-lock" id="footerLock" onclick="toggleAdminAuth()" title="Admin Login">üîí</button>
        </div>
        <span id="footer-stats"></span><br>
        <span id="admin-status">üîí Voting ist gesch√ºtzt</span>
    </div>

    <script>
    let places = [];
    let votes = JSON.parse(localStorage.getItem('fancyVotes') || '{}');
    let voteSummary = {}; // Aggregated votes from Supabase
    let activeCity = 'all';
    let activeCat = 'all';
    let supabaseAvailable = false;
    let isAdmin = false;

    // Admin password
    const ADMIN_PASSWORD = 'fancyadmin2026';
    const AUTH_KEY = 'fancyAdminAuth';

    // Supabase config
    const SUPABASE_URL = 'https://qhsspdblxbmfhjohmmgz.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_1vYTo5zGfGAxfSoVBb4MFA_npt_GxnE';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Check admin auth status on load
    function checkAdminAuth() {
        isAdmin = sessionStorage.getItem(AUTH_KEY) === 'true';
        updateAdminUI();
    }

    // Update UI based on admin status
    function updateAdminUI() {
        const lockBtn = document.getElementById('adminLock');
        const footerLock = document.getElementById('footerLock');
        const adminStatus = document.getElementById('admin-status');

        if (isAdmin) {
            lockBtn.textContent = 'üîì';
            lockBtn.classList.add('authenticated');
            footerLock.textContent = 'üîì';
            footerLock.classList.add('authenticated');
            adminStatus.textContent = '‚úÖ Admin-Modus aktiv ‚Äî Du kannst voten!';
        } else {
            lockBtn.textContent = 'üîí';
            lockBtn.classList.remove('authenticated');
            footerLock.textContent = 'üîí';
            footerLock.classList.remove('authenticated');
            adminStatus.textContent = 'üîí Voting ist gesch√ºtzt (klick üîí zum Entsperren)';
        }
        render();
    }

    // Toggle admin authentication
    function toggleAdminAuth() {
        if (isAdmin) {
            // Logout
            isAdmin = false;
            sessionStorage.removeItem(AUTH_KEY);
            updateAdminUI();
            showToast('üîí Abgemeldet');
        } else {
            // Login
            const password = prompt('üîê Admin-Passwort eingeben:');
            if (password === null) return; // Cancelled
            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                sessionStorage.setItem(AUTH_KEY, 'true');
                updateAdminUI();
                showToast('‚úÖ Admin-Modus aktiviert!');
            } else {
                alert('‚ùå Falsches Passwort');
            }
        }
    }

    // Generate or retrieve voter ID
    function getVoterId() {
        let voterId = localStorage.getItem('fancyVoterId');
        if (!voterId) {
            voterId = crypto.randomUUID();
            localStorage.setItem('fancyVoterId', voterId);
        }
        return voterId;
    }
    const voterId = getVoterId();

    const catEmojis = {
        'Caf√©':'‚òï', 'Brunch':'ü•ê', 'Bar':'üç∏', 'Patisserie':'üßÅ',
        'Juice Bar':'ü•§', 'Bistro':'ü•ñ'
    };

    // Tag-based filter: which tags match each filter button
    const filterTags = {
        'Caf√©': ['cafe','caf√©','coffee','specialty coffee'],
        'Brunch': ['brunch','breakfast'],
        'Bar': ['bar','cocktails','wine'],
        'Patisserie': ['patisserie','bakery'],
        'Juice Bar': ['juice','smoothies'],
    };

    function formatFollowers(n) {
        if (n >= 1000000) return (n/1000000).toFixed(1) + 'M';
        if (n >= 1000) return (n/1000).toFixed(1) + 'K';
        return n.toString();
    }

    function escapeHtml(text) {
        const d = document.createElement('div');
        d.textContent = text;
        return d.innerHTML;
    }

    function getFiltered() {
        return places.filter(p => {
            if (activeCity !== 'all' && p.city !== activeCity) return false;
            if (activeCat !== 'all') {
                const matchTags = filterTags[activeCat] || [];
                const pTags = (p.tags || []).map(t => t.toLowerCase());
                const catMatch = p.category === activeCat || matchTags.some(t => pTags.includes(t));
                if (!catMatch) return false;
            }
            return true;
        });
    }

    function render() {
        const filtered = getFiltered();
        const yesCount = filtered.filter(p => votes[p.handle] === 'yes').length;
        const noCount = filtered.filter(p => votes[p.handle] === 'no').length;

        document.getElementById('stats').innerHTML =
            `<span>${filtered.length} Places</span>` +
            (yesCount || noCount ? `<span>üëç ${yesCount} ¬∑ üëé ${noCount}</span>` : '');

        const ref = places.filter(p => p.source === 'positive-list').length;
        document.getElementById('footer-stats').textContent = `${ref} Referenz + ${places.length - ref} Discovery = ${places.length} Places`;

        const container = document.getElementById('places');
        container.innerHTML = filtered.map(p => {
            const emoji = catEmojis[p.category] || 'üìç';
            const isPositive = p.source === 'positive-list';
            const voteState = votes[p.handle] || '';
            const summary = voteSummary[p.handle] || { yes_count: 0, no_count: 0 };
            const hasVotes = summary.yes_count > 0 || summary.no_count > 0;

            // Only show vote buttons if admin is authenticated
            const voteButtons = isAdmin ? `
                <div class="vote-btns">
                    <button class="vote-btn ${voteState === 'yes' ? 'voted-yes' : ''}"
                            onclick="vote('${p.handle}', 'yes')">üëç</button>
                    <button class="vote-btn ${voteState === 'no' ? 'voted-no' : ''}"
                            onclick="vote('${p.handle}', 'no')">üëé</button>
                </div>
            ` : '';

            // Admin tag editor
            const adminTags = isAdmin ? `
                <div class="admin-tags-section">
                    <div class="admin-tag-chips">
                        ${(p.tags || []).map(tag => `
                            <span class="admin-tag-chip" id="tag-chip-${p.handle}-${tag}"
                                  onclick="removeTag('${p.handle}', '${tag}')" title="Klicken zum Entfernen">${tag}</span>
                        `).join('')}
                        <span class="admin-tag-add" id="tag-input-${p.handle}"
                              onclick="showTagInput('${p.handle}')">+</span>
                    </div>
                </div>
            ` : '';

            // Admin approve/reject buttons
            const adminActions = isAdmin ? `
                <div class="admin-actions">
                    <button class="admin-btn approve ${p.status === 'approved' ? 'active' : ''}"
                            onclick="updatePlaceStatus('${p.handle}', 'approved')">‚úÖ</button>
                    <button class="admin-btn reject ${p.status === 'rejected' ? 'active' : ''}"
                            onclick="updatePlaceStatus('${p.handle}', 'rejected')">‚ùå</button>
                </div>
            ` : '';

            // Status class for visual feedback
            const statusClass = p.status === 'approved' ? 'status-approved' :
                               p.status === 'rejected' ? 'status-rejected' : '';

            return `
            <div class="place-card ${statusClass}">
                <div class="place-header">
                    <div class="place-avatar ${isPositive ? '' : 'discovery'}">${emoji}</div>
                    <div class="place-info">
                        <div class="place-name">${escapeHtml(p.name || p.handle)}</div>
                        <div class="place-handle">@${p.handle}</div>
                    </div>
                </div>
                ${p.bio ? `<div class="place-body"><div class="place-bio">${escapeHtml(p.bio)}</div></div>` : ''}
                ${adminTags}
                <div class="place-tags">
                    <span class="tag ${isPositive ? 'source-pos' : 'source-disc'}">${isPositive ? '‚úì Referenz' : 'üîç Discovery'}</span>
                    <span class="tag cat">${emoji} ${p.category}</span>
                    <span class="tag city">üìç ${p.city}</span>
                    <span class="tag followers">${formatFollowers(p.followers)} followers</span>
                    ${p.socialProof ? `<span class="tag proof">‚≠ê ${escapeHtml(p.socialProof)}</span>` : ''}
                </div>
                ${hasVotes ? `<div class="vote-counts">üëç ${summary.yes_count} ¬∑ üëé ${summary.no_count}</div>` : ''}
                <div class="place-actions">
                    <a href="https://instagram.com/${p.handle}" target="_blank" class="insta-btn">üì∏ Profil √∂ffnen</a>
                    ${adminActions}${voteButtons}
                </div>
            </div>`;
        }).join('');
    }

    function setCity(city, el) {
        activeCity = city;
        document.querySelectorAll('#city-filters .filter-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    function setCat(cat, el) {
        activeCat = cat;
        document.querySelectorAll('#cat-filters .filter-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        render();
    }

    async function vote(handle, v) {
        // Only allow voting if admin is authenticated
        if (!isAdmin) {
            alert('üîí Bitte melde dich als Admin an, um zu voten. Klicke auf das üîí Symbol oben rechts.');
            return;
        }

        const newVote = votes[handle] === v ? '' : v;
        votes[handle] = newVote;
        localStorage.setItem('fancyVotes', JSON.stringify(votes));
        render();
        updateExportBar();

        // Sync with Supabase if available
        if (supabaseAvailable) {
            try {
                if (newVote === '') {
                    // Delete vote
                    await sb
                        .from('votes')
                        .delete()
                        .eq('handle', handle)
                        .eq('voter_id', voterId);
                } else {
                    // Upsert vote (delete old, insert new)
                    await sb
                        .from('votes')
                        .delete()
                        .eq('handle', handle)
                        .eq('voter_id', voterId);

                    await sb
                        .from('votes')
                        .insert({
                            handle: handle,
                            vote: v,
                            voter_id: voterId
                        });
                }
                // Refresh vote summary
                await loadVoteSummary();
                render();
            } catch (e) {
                console.error('Supabase sync error:', e);
                // Silent fail - localStorage is already updated
            }
        }
    }

    async function loadVoteSummary() {
        try {
            const { data, error } = await sb
                .from('vote_summary')
                .select('handle, yes_count, no_count');

            if (error) throw error;

            // Convert to lookup object
            voteSummary = {};
            data.forEach(row => {
                voteSummary[row.handle] = {
                    yes_count: row.yes_count || 0,
                    no_count: row.no_count || 0
                };
            });
            supabaseAvailable = true;
        } catch (e) {
            console.error('Failed to load vote summary:', e);
            supabaseAvailable = false;
        }
    }

    function updateExportBar() {
        // Only show export bar if admin is authenticated
        if (!isAdmin) {
            document.getElementById('export-bar').style.display = 'none';
            return;
        }
        const yes = Object.entries(votes).filter(([k,v]) => v === 'yes');
        const no = Object.entries(votes).filter(([k,v]) => v === 'no');
        const total = yes.length + no.length;
        const bar = document.getElementById('export-bar');
        const count = document.getElementById('export-count');
        bar.style.display = total > 0 ? 'flex' : 'none';
        count.textContent = `${yes.length} üëç ¬∑ ${no.length} üëé`;
    }

    async function exportVotes() {
        if (!isAdmin) {
            alert('üîí Admin-Login erforderlich');
            return;
        }

        let yesList, noList;

        if (supabaseAvailable) {
            // Use Supabase data
            try {
                const { data, error } = await sb
                    .from('vote_summary')
                    .select('handle, yes_count, no_count');

                if (error) throw error;

                const yesHandles = data
                    .filter(row => row.yes_count > 0)
                    .sort((a, b) => b.yes_count - a.yes_count)
                    .map(row => `@${row.handle} (${row.yes_count})`);

                const noHandles = data
                    .filter(row => row.no_count > 0)
                    .sort((a, b) => b.no_count - a.no_count)
                    .map(row => `@${row.handle} (${row.no_count})`);

                yesList = yesHandles;
                noList = noHandles;
            } catch (e) {
                console.error('Export from Supabase failed, falling back to localStorage:', e);
                // Fallback to localStorage
                const yes = Object.entries(votes).filter(([k,v]) => v === 'yes').map(([k]) => '@' + k);
                const no = Object.entries(votes).filter(([k,v]) => v === 'no').map(([k]) => '@' + k);
                yesList = yes;
                noList = no;
            }
        } else {
            // Use localStorage
            const yes = Object.entries(votes).filter(([k,v]) => v === 'yes').map(([k]) => '@' + k);
            const no = Object.entries(votes).filter(([k,v]) => v === 'no').map(([k]) => '@' + k);
            yesList = yes;
            noList = no;
        }

        let text = '‚ú® Fancy Places Voting\n\n';
        if (yesList.length) text += 'üëç Fancy:\n' + yesList.join(', ') + '\n\n';
        if (noList.length) text += 'üëé Nicht fancy:\n' + noList.join(', ') + '\n\n';
        text += `(${yesList.length + noList.length} bewertet)`;

        // Try native share (works great on mobile)
        if (navigator.share) {
            navigator.share({ text }).catch(() => {});
            return;
        }
        // Fallback: clipboard
        navigator.clipboard.writeText(text).then(() => {
            showToast('‚úÖ In Zwischenablage kopiert!');
        }).catch(() => {
            // Last resort fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            try { document.execCommand('copy'); showToast('‚úÖ In Zwischenablage kopiert!'); }
            catch(e) { showToast('‚ùå Kopieren fehlgeschlagen ‚Äî Text im Konsolelog'); console.log(text); }
            ta.remove();
        });
    }

    function showToast(msg) {
        const toast = document.createElement('div');
        toast.className = 'export-toast';
        toast.textContent = msg;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }

    function buildFilters() {
        const cities = [...new Set(places.map(p => p.city))].sort((a,b) => {
            const order = ['Berlin','Hamburg','D√ºsseldorf','K√∂ln','M√ºnchen'];
            const ai = order.indexOf(a), bi = order.indexOf(b);
            return (ai === -1 ? 99 : ai) - (bi === -1 ? 99 : bi);
        });
        const cats = [...new Set(places.map(p => p.category))].sort();

        const cityDiv = document.getElementById('city-filters');
        cityDiv.innerHTML = `<button class="filter-btn city-btn active" onclick="setCity('all', this)">Alle St√§dte</button>` +
            cities.map(c => `<button class="filter-btn city-btn" onclick="setCity('${c}', this)">${c}</button>`).join('');

        const catDiv = document.getElementById('cat-filters');
        const mainCats = ['Caf√©','Brunch','Bar','Patisserie','Juice Bar'];
        catDiv.innerHTML = `<button class="filter-btn active" onclick="setCat('all', this)">Alle</button>` +
            mainCats.map(c => `<button class="filter-btn" onclick="setCat('${c}', this)">${catEmojis[c]||'üìç'} ${c}</button>`).join('');
    }

    // Available tags for suggestions
    const AVAILABLE_TAGS = ['cafe', 'brunch', 'breakfast', 'bar', 'cocktails', 'wine', 'patisserie', 'bakery', 'juice', 'bistro', 'restaurant', 'lunch', 'dinner', 'coffee', 'matcha', 'specialty coffee', 'healthy', 'vegan'];

    // Load places from Supabase
    async function loadPlacesFromSupabase() {
        try {
            const { data, error } = await sb
                .from('places_live')
                .select('*');

            if (error) throw error;

            // Transform Supabase data to match the expected format
            return data.map(p => ({
                id: p.id,
                handle: p.handle,
                name: p.name || p.handle,
                bio: p.bio,
                city: p.city,
                category: p.category,
                tags: p.tags || [],
                latitude: p.latitude,
                longitude: p.longitude,
                followers: p.followers || 0,
                posts: p.posts || 0,
                is_business: p.is_business,
                is_active: p.is_active,
                status: p.status,
                source: p.source || 'discovery'
            }));
        } catch (e) {
            console.error('Failed to load from Supabase:', e);
            return null;
        }
    }

    // Admin: Update place tags
    async function updatePlaceTags(handle, newTags) {
        if (!isAdmin) return;

        try {
            const { error } = await sb
                .from('places_live')
                .update({ tags: newTags })
                .eq('handle', handle);

            if (error) throw error;

            // Update local state
            const place = places.find(p => p.handle === handle);
            if (place) {
                place.tags = newTags;
            }

            showToast('‚úÖ Tags gespeichert');
        } catch (e) {
            console.error('Failed to update tags:', e);
            showToast('‚ùå Fehler beim Speichern');
        }
    }

    // Admin: Update place status
    async function updatePlaceStatus(handle, status) {
        if (!isAdmin) return;

        try {
            const { error } = await sb
                .from('places_live')
                .update({ status: status })
                .eq('handle', handle);

            if (error) throw error;

            // Update local state
            const place = places.find(p => p.handle === handle);
            if (place) {
                place.status = status;
            }

            render();
            showToast(status === 'approved' ? '‚úÖ Approved' : '‚ùå Rejected');
        } catch (e) {
            console.error('Failed to update status:', e);
            showToast('‚ùå Fehler beim Speichern');
        }
    }

    // Show tag input for a place
    function showTagInput(handle) {
        const container = document.getElementById(`tag-input-${handle}`);
        if (!container) return;

        container.innerHTML = `
            <input type="text" class="admin-tag-input" id="tag-input-field-${handle}"
                   placeholder="Tag hinzuf√ºgen..." list="tag-suggestions-${handle}"
                   onkeydown="if(event.key==='Enter'){addTag('${handle}');event.preventDefault();}">
            <datalist id="tag-suggestions-${handle}">
                ${AVAILABLE_TAGS.map(t => `<option value="${t}">`).join('')}
            </datalist>
        `;

        setTimeout(() => {
            const input = document.getElementById(`tag-input-field-${handle}`);
            if (input) input.focus();
        }, 10);
    }

    // Add a tag to a place
    async function addTag(handle) {
        const input = document.getElementById(`tag-input-field-${handle}`);
        if (!input) return;

        const tag = input.value.trim().toLowerCase();
        if (!tag) {
            // Cancel - restore the + button
            render();
            return;
        }

        const place = places.find(p => p.handle === handle);
        if (!place) return;

        const currentTags = place.tags || [];
        if (currentTags.includes(tag)) {
            showToast('‚ö†Ô∏è Tag existiert bereits');
            render();
            return;
        }

        const newTags = [...currentTags, tag];
        await updatePlaceTags(handle, newTags);
        render();
    }

    // Remove a tag from a place
    async function removeTag(handle, tag) {
        const place = places.find(p => p.handle === handle);
        if (!place) return;

        const currentTags = place.tags || [];
        const newTags = currentTags.filter(t => t !== tag);

        // Visual feedback before actual removal
        const chip = document.getElementById(`tag-chip-${handle}-${tag}`);
        if (chip) {
            chip.classList.add('removing');
        }

        // Small delay for visual feedback
        setTimeout(async () => {
            await updatePlaceTags(handle, newTags);
            render();
        }, 300);
    }

    // Load data and initialize
    async function init() {
        // Check admin auth first
        checkAdminAuth();

        // Load places from Supabase (with fallback to places.json)
        const supabasePlaces = await loadPlacesFromSupabase();
        if (supabasePlaces) {
            places = supabasePlaces;
            supabaseAvailable = true;
        } else {
            // Fallback to places.json
            try {
                const response = await fetch('places.json?v=2&t=' + Date.now());
                const data = await response.json();
                places = data;
            } catch (e) {
                console.error('Failed to load places:', e);
                places = [];
            }
        }

        // Sort: positive first, then discovery; within each group by followers desc
        places.sort((a, b) => {
            if (a.source !== b.source) return a.source === 'positive-list' ? -1 : 1;
            return (b.followers || 0) - (a.followers || 0);
        });

        buildFilters();

        // Load vote summary from Supabase
        await loadVoteSummary();

        // Re-sort: unvoted to top (now that we have Supabase data)
        const hasAnyVote = (h) => !!(votes[h] || (voteSummary[h] && (voteSummary[h].yes_count + voteSummary[h].no_count > 0)));
        places.sort((a, b) => {
            const aV = hasAnyVote(a.handle) ? 1 : 0;
            const bV = hasAnyVote(b.handle) ? 1 : 0;
            if (aV !== bV) return aV - bV;
            return (b.followers || 0) - (a.followers || 0);
        });

        render();
        updateExportBar();
    }

    init();
    </script>
</body>
</html>
